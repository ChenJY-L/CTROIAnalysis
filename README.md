# 超声DICOM图像ROI分析工具 

**作者:** 陈嘉宇
**邮箱** jiayu_chen@tju.edu.cn
**日期:** 2025年6月5日

## 项目概述

本项目是一个基于 MATLAB 的应用程序，用于对超声DICOM图像序列进行定量分析。其主要目标是在初始帧中识别感兴趣区域 (ROI)，追踪该ROI在多个帧和文件中的变化，并将这些变化与指定事件相关联。一个关键特性是能够检测和追踪表皮层，从而动态校正ROI的位置以补偿组织运动。该工具还支持将多边形ROI（特别是四边形）分割成更小的子ROI进行更精细的分析。分析结果，包括像素强度统计和表皮位移，将以时间序列图表的形式展示。

## 主要功能

* **DICOM文件处理:**
    * 扫描用户选定的包含DICOM文件的文件夹。
    * 允许用户指定在序列开头和结尾跳过的文件数量。
    * 读取多帧DICOM文件。
* **ROI 定义:**
    * 在选定DICOM序列的第一帧上进行交互式ROI绘制。
    * 支持多种ROI形状：矩形、椭圆、多边形 (带有实时距离/角度测量) 和自由手绘。
    * 可从先前保存的 `.mat` 文件加载ROI。
    * 保存绘制的ROI掩码及其定义数据。
* **表皮检测与ROI校正:**
    * 允许绘制一个专门用于Canny边缘检测的独立ROI (`edgeRoiMask`)，旨在识别表皮层。
    * 在每帧的 `edgeRoiMask` 内检测最上方的边缘。
    * 可选功能：根据检测到的表皮相对于其初始位置的位移，在后续帧中校正主ROI的垂直位置，以帮助在组织运动时保持ROI在目标组织上的准确性。
* **灰度值矫正:**
    * 根据实验测量得到的灰度值变化和耦合剂厚度之间的关系，建立了一个线性灰度矫正模型。用于矫正耦合剂厚度变化导致的灰度值变化。

* **子ROI分析 (针对多边形ROI):**
    * 如果主ROI是多边形（此步骤特指四边形），可根据用户定义的比例将其分割成网格状的较小子ROI。
    * 对每个子ROI独立进行分析。
* **像素阈值分析:**
    * 用户可自定义像素强度阈值。
    * 计算每个处理帧中，ROI内部（以及每个子ROI内部）低于或等于此阈值的像素所占的百分比。
* **时间序列分析与可视化:**
    * 按用户定义的间隔（例如，每N帧）处理帧。
    * 生成图表显示：
        * 主ROI中低于阈值的像素百分比随时间的变化。
        * 检测到的表皮平均垂直位置（深度，单位mm）随时间的变化。
        * 子ROI阈值分析结果随时间变化的独立图表。
    * 将从 `events.csv` 文件读取的事件标记叠加到时间序列图上。
* **直方图数据分析**
    * 对各帧图像ROI内的像素进行直方图统计分析，直方图`bin`默认间隔为5（默认的直方图为统计为**左闭右开**，这里根据实际需要设置为了**左开右闭**）

* **数据/结果输出:**
    * 将绘制的ROI（主ROI和边缘检测ROI）保存为 `.png` (可视化图像) 和 `.mat` (数据) 文件。
    * 可选功能：将处理后的帧（带有ROI和表皮层叠加）保存为 `.avi` 视频文件。
    * 在MATLAB命令窗口中显示处理进度和信息。

## 项目文件结构及说明

本项目包含一个主脚本 (`ROIAnalysisFinal.m`) 和多个辅助函数：

1.  **`ROIAnalysisFinal.m` (主脚本):**
    * 协调从数据输入到结果可视化的整个工作流程。
    * 处理用户交互，如选择目录、跳过文件、定义ROI、设置阈值等参数。
    * 遍历指定的DICOM文件及其帧。
    * 调用辅助函数完成特定任务，如ROI绘制、表皮检测、ROI校正和子ROI生成。
    * 汇总结果并生成最终图表。
2.  **`scanDicomFiles.m`:**
    * 扫描指定目录，识别有效的DICOM文件。
3.  **`setSkipFiles.m`:**
    * 提示用户输入在序列开头和结尾要跳过的文件数量。
4.  **`drawROI.m`:**
    * 管理交互式ROI绘制过程，支持多种形状或从文件加载。
    * 调用 `drawPolygonWithDistance.m` 实现带距离显示的多边形绘制。
5.  **`drawPolygonWithDistance.m`:**
    * 自定义多边形绘制函数，在绘制时实时显示边长（mm）和角度。
6.  **`drawEdgeDetectROI.m`:**
    * 用于定义表皮检测专用ROI的函数。
7.  **`plotResult.m`:**
    - 用于绘制LEP随时间的变化图
    - 表皮层位移随时间的变化图
    - ROI区域内灰度均值随时间的变化图
    - 直方图变化量随时间的变化图
    - 直方图各个分量随时间的变化趋势
    - 是否导出数据
8.  **`plotSubROI.m`:**
    - 绘制各个子ROI中LEP随时间的变化趋势
9.  **`plotHistogram`:**
    - 绘制直方图的统计结果
10.  **`setBlockRatio.m`:**
     * 允许用户定义分割比例，将四边形ROI分割成更小的子区域。
11.  **`detectEpidermis.m`:**
     * 在指定的 `edgeRoiMask` 内使用Canny边缘检测算法检测表皮层。
12.  **`fixROI.m`:**
     * 根据表皮层的垂直位移调整原始ROI的位置。
13.  **`readEvents.m`:**
     * 从 `events.csv` 文件中读取事件时间点和标签。

## 工作流程

1.  **初始化:** 清理工作区，关闭所有图像窗口，清空命令行。
2.  **目录选择:** 用户选择包含DICOM文件的文件夹。
3.  **DICOM文件扫描:** 脚本使用 `scanDicomFiles.m` 扫描所选目录中的DICOM文件。
4.  **文件跳过设置:** 用户通过 `setSkipFiles.m` 指定在序列的开头或结尾要跳过的文件数。
5.  **加载首帧用于ROI定义:** 读取（第一个未跳过的）DICOM文件的第一帧，并从DICOM元数据中提取像素间距信息。
6.  **主ROI定义:** 用户通过 `drawROI.m` 在第一帧上绘制主ROI。支持多种形状，包括通过 `drawPolygonWithDistance.m` 绘制的带实时反馈的多边形，或从文件加载ROI。
7.  **子ROI定义 (条件性):** 如果绘制的ROI是多边形（用于此步骤时假定为四边形），`setBlockRatio.m` 会提示用户定义如何将其分割为子ROI。
8.  **边缘检测ROI定义:** 用户使用 `drawEdgeDetectROI.m` 绘制用于表皮检测的专用ROI。
9.  **阈值输入:** 用户提供一个像素强度阈值。
10. **参数输入:** 用户设置帧处理间隔、是否启用ROI校正、是否保存视频、是否进行灰度矫正等参数。
11. **处理循环 (遍历文件和帧):**
    * 对每个选定的DICOM文件：
        * 读取图像数据和元数据（采集时间、帧时间）。
        * 对每个选定的帧（基于帧间隔）：
            * 提取当前帧。
            * **表皮检测:** 调用 `detectEpidermis.m` 在 `edgeRoiMask` 内查找表皮。首帧的表皮位置存为参考。
            * **ROI 校正 (如果启用):** 计算当前表皮相对于参考位置的垂直位移，`fixROI.m`据此调整 `roiMask`（如果适用，也调整 `subMasks`）的垂直位置。
            * **视频保存 (如果启用):** 当前帧及ROI、表皮点和子ROI的叠加显示，并写入AVI视频文件。
            * **ROI分析:** 提取（校正后）`roiMask` 内的像素，计算低于或等于阈值的像素百分比并存储。
            * **子ROI分析 (如果适用):** 对每个子ROI，从其顶点生成掩码，分析其内部像素并存储结果。
            * 存储当前帧的时间戳和平均表皮位置。
12. **事件数据加载:** 使用 `readEvents.m` 从 `events.csv` 文件读取事件时间戳和标签。
13. **结果绘图:**
    * **图1 (主ROI):** 低于阈值像素的百分比 vs. 时间。叠加 `events.csv` 中的事件标记。
    * **图2 (表皮追踪):** 平均表皮Y坐标 (深度mm) vs. 时间。叠加事件标记。
    * **图3 (子ROI, 如果适用):** 在平铺布局中为每个子ROI生成低于阈值像素百分比 vs. 时间的图表。叠加事件标记。

## 输入要求

* **DICOM 文件:** 包含超声DICOM图像序列的文件夹。文件可以是单帧或多帧。
* **`events.csv` (可选):** 如果需要在图表上标记事件，一个名为 `events.csv` 的CSV文件必须存在于所选的DICOM目录中。它应包含：
    * `Time`列 (格式: `yyyyMMdd HH:mm`)。
    * `Label`列 (事件的文本描述)。
* **用户交互:** 脚本通过对话框需要用户输入：
    * 选择DICOM目录。
    * 指定要跳过的文件。
    * 选择ROI形状并绘制/加载它。
    * 选择并绘制边缘检测ROI。
    * 设置子ROI
    * 设置像素强度阈值。
    * 设置帧处理间隔。
    * 启用/禁用ROI校正。
    * 启用/禁用视频保存。
    * (如果适用) 定义子ROI的分割比例。

## 输出

* **MATLAB 绘图结果:**
    * 主ROI分析结果随时间变化的图表。
    * 表皮深度随时间变化的图表。
    * (如果适用) 子ROI分析结果随时间变化的平铺图表。
* **保存的文件 (在DICOM目录中):**
    * `ROI.png`: 第一帧图像与主ROI的叠加图。
    * `ROI.mat`: 包含主ROI的 `roiMask`, `roiData`, 和 `roiShapeChoice`。
    * `EdgeROI.png`: 第一帧图像与边缘检测ROI的叠加图。
    * `EdgeROI.mat`: 包含边缘检测ROI的 `edgeRoiMask`。
    * `output.avi` (可选): 显示已处理帧及叠加信息的视频文件。
    * `ProcessedData.xlsx`(可选): 保存绘图的原始数据和相对变化量
    * (如果使用了 `setBlockRatio.m`) 一个显示主ROI及其子ROI分割情况的图像窗口。

## 如何运行

1.  确保所有 `.m` 文件都在 MATLAB 的搜索路径中，或者位于当前工作目录。
2.  在 MATLAB 编辑器中打开 `ROIAnalysisFinal.m`。
3.  点击编辑器中的“运行”按钮，或者在 MATLAB 命令窗口中输入 `ROIAnalysisFinal` 并按 Enter。
4.  按照屏幕上的提示和对话框进行操作：
    * 选择包含DICOM文件的目录。
    * 指定要跳过的文件。
    * 绘制/加载主ROI。
    * (如果适用) 定义子ROI的分割比例。
    * 绘制/加载边缘检测ROI。
    * 输入像素阈值。
    * 设置其他处理参数（帧间隔、ROI校正、视频保存）。
5.  脚本将处理文件并显示结果图表。输出文件将保存在选定的DICOM目录中。

## 依赖项

* MATLAB (例如 R2020a 或更高版本)
* Image Processing Toolbox (图像处理工具箱)，用于 `edge`, `imshow`, `createMask`, `labeloverlay`, `dicomread`, `dicominfo`, `drawrectangle`, `drawellipse`, `drawpolygon`, `drawfreehand`, `poly2mask` 等函数。
* 如果 `getPixelData(dFile)` 使用了 `dicomFile` 对象，请确保该对象及其方法可用（可能是特定MATLAB版本或工具箱的一部分）。脚本中也使用了标准的 `dicomread`。